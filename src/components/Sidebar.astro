---
interface Props {
  tags: { name: string; count: number }[];
  totalCount: number;
  videoIds?: string[];
  currentTag?: string;
}

const { tags, totalCount, videoIds = [], currentTag = '' } = Astro.props;
---

<aside class="hidden md:flex flex-col w-80 h-full bg-card-light/95 dark:bg-card-dark/95 backdrop-blur-md border-r border-border-light dark:border-border-dark shrink-0 z-20 shadow-[2px_0_12px_-4px_rgba(0,0,0,0.05)]">
  <div class="p-8 pb-6 border-b border-border-light/50 dark:border-border-dark/50">
    <a href="/" class="block group">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-stone-800 to-stone-900 dark:from-stone-200 dark:to-stone-300 flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow">
          <svg class="w-5 h-5 text-white dark:text-stone-900 ml-0.5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-serif font-semibold text-text-primary dark:text-stone-100 tracking-tight group-hover:text-primary dark:group-hover:text-stone-300 transition-colors">v<span class="text-stone-400 dark:text-stone-500">/</span></h1>
          <p class="text-[10px] font-sans text-text-secondary dark:text-stone-500 uppercase tracking-[0.15em] font-medium">curated talks</p>
        </div>
      </div>
    </a>
  </div>

  <div class="px-8 py-6 space-y-6">
    <button
      id="feeling-lucky"
      class="w-full flex items-center justify-center gap-2 py-2.5 border border-stone-200 dark:border-stone-700 rounded-md bg-stone-50 dark:bg-stone-800/60 hover:bg-white dark:hover:bg-stone-700 hover:border-primary/30 dark:hover:border-stone-500 hover:shadow-classic text-sm font-serif text-text-primary dark:text-stone-200 transition-all duration-300 group"
    >
      <span class="material-symbols-outlined text-[18px] text-stone-400 group-hover:text-primary dark:group-hover:text-stone-200 transition-colors">casino</span>
      <span>Feeling Lucky</span>
    </button>

    <div class="relative group">
      <span class="absolute left-0 top-1/2 -translate-y-1/2 text-stone-400 group-focus-within:text-primary dark:group-focus-within:text-stone-200 transition-colors">
        <span class="material-symbols-outlined text-[20px]">search</span>
      </span>
      <input
        id="tag-search"
        class="w-full bg-transparent border-b border-stone-300 dark:border-stone-700 py-2 pl-7 pr-2 text-sm text-text-primary dark:text-stone-200 placeholder:text-stone-400 placeholder:font-serif placeholder:italic focus:outline-none focus:border-primary dark:focus:border-stone-400 focus:ring-0 transition-all"
        placeholder="Find by tag..."
        type="text"
      />
    </div>
  </div>

  <div class="flex-1 overflow-y-auto px-8 py-2">
    <h3 class="text-xs font-bold text-stone-400 dark:text-stone-600 uppercase tracking-widest mb-4 sticky top-0 bg-card-light dark:bg-card-dark py-2 z-10">Browse Tags</h3>
    <ul id="tag-list" class="space-y-1 font-serif">
      <li>
        <a
          href="/"
          data-tag=""
          class={`tag-filter-btn w-full flex items-center justify-between group py-2 px-3 -mx-3 rounded-md transition-colors ${currentTag === '' ? 'bg-stone-100 dark:bg-stone-800 text-primary dark:text-white' : 'hover:bg-stone-50 dark:hover:bg-stone-800/40 text-text-secondary dark:text-stone-400 hover:text-text-primary dark:hover:text-stone-200'}`}
        >
          <span class="text-sm font-medium italic">#All Videos</span>
          <span class={`text-[10px] font-sans text-stone-500 dark:text-stone-400 font-semibold ${currentTag === '' ? '' : 'opacity-0 group-hover:opacity-100'}`}>{totalCount}</span>
        </a>
      </li>
      {tags.map(tag => (
        <li class="tag-item" data-tag={tag.name.toLowerCase()}>
          <a
            href={`/?tag=${tag.name.toLowerCase()}`}
            data-tag={tag.name.toLowerCase()}
            class={`tag-filter-btn w-full flex items-center justify-between group py-2 px-3 -mx-3 rounded-md transition-colors ${currentTag === tag.name.toLowerCase() ? 'bg-stone-100 dark:bg-stone-800 text-primary dark:text-white' : 'hover:bg-stone-50 dark:hover:bg-stone-800/40 text-text-secondary dark:text-stone-400 hover:text-text-primary dark:hover:text-stone-200'}`}
          >
            <span class="text-sm">#{tag.name}</span>
            <span class={`tag-count text-[10px] font-sans text-stone-400 ${currentTag === tag.name.toLowerCase() ? '' : 'opacity-0 group-hover:opacity-100'} transition-opacity`}>{tag.count}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>

  <div class="p-8 border-t border-border-light dark:border-border-dark mt-auto bg-stone-50/80 dark:bg-stone-900/40">
    <div class="flex items-center gap-2 text-stone-400 mb-2">
      <span class="material-symbols-outlined text-[16px]">history</span>
      <span class="text-[10px] uppercase tracking-wider font-bold">Last Viewed</span>
    </div>
    <a id="last-viewed" class="block truncate text-sm font-serif italic text-text-secondary dark:text-stone-400 hover:text-primary dark:hover:text-stone-200 transition-colors" href="#">
      â€”
    </a>
    <div class="mt-6 pt-4 border-t border-stone-200 dark:border-stone-800 flex justify-between items-center opacity-80">
      <div class="flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
        <span class="text-[10px] font-bold text-stone-400 dark:text-stone-500 uppercase tracking-widest">Last Built</span>
      </div>
      <span id="build-time" class="text-[10px] font-serif italic text-stone-500 dark:text-stone-600"></span>
    </div>
    <a
      href="https://github.com/luffy-taro/v-app"
      target="_blank"
      rel="noopener noreferrer"
      class="mt-4 flex items-center gap-2 text-stone-400 hover:text-text-primary dark:hover:text-stone-200 transition-colors group"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
      </svg>
      <span class="text-[10px] font-sans font-medium uppercase tracking-wider">Contribute on GitHub</span>
    </a>
  </div>
</aside>

<!-- Store video IDs for feeling lucky -->
<script define:vars={{ videoIds }}>
  window.__videoIds = videoIds;
</script>

<script>
  declare global {
    interface Window {
      __videoIds: string[];
    }
  }

  // Tag search filtering (filters the tag list in sidebar)
  const tagSearch = document.getElementById('tag-search') as HTMLInputElement;
  const tagItems = document.querySelectorAll('.tag-item');

  tagSearch?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    tagItems.forEach(item => {
      const tag = item.getAttribute('data-tag') || '';
      (item as HTMLElement).style.display = tag.includes(query) ? '' : 'none';
    });
  });

  // Highlight active tag based on URL params
  const urlParams = new URLSearchParams(window.location.search);
  const currentUrlTag = urlParams.get('tag') || '';
  const tagButtons = document.querySelectorAll('.tag-filter-btn');
  const activeClass = 'bg-stone-100 dark:bg-stone-800 text-primary dark:text-white';
  const inactiveClass = 'hover:bg-stone-50 dark:hover:bg-stone-800/40 text-text-secondary dark:text-stone-400 hover:text-text-primary dark:hover:text-stone-200';

  tagButtons.forEach(btn => {
    const tag = btn.getAttribute('data-tag') || '';
    const isActive = tag === currentUrlTag;

    // Remove existing classes and apply correct ones
    activeClass.split(' ').forEach(c => btn.classList.remove(c));
    inactiveClass.split(' ').forEach(c => btn.classList.remove(c));
    (isActive ? activeClass : inactiveClass).split(' ').forEach(c => btn.classList.add(c));

    // Show count on active tag
    const countEl = btn.querySelector('.tag-count, span:last-child');
    if (countEl) {
      (countEl as HTMLElement).classList.toggle('opacity-0', !isActive);
      (countEl as HTMLElement).classList.toggle('group-hover:opacity-100', !isActive);
    }
  });

  // Feeling lucky
  const feelingLucky = document.getElementById('feeling-lucky');
  feelingLucky?.addEventListener('click', () => {
    const ids = window.__videoIds;
    if (ids && ids.length > 0) {
      const randomId = ids[Math.floor(Math.random() * ids.length)];
      window.location.href = `/video/${randomId}`;
    }
  });

  // Hydrate last viewed
  const lastViewed = JSON.parse(localStorage.getItem('lastViewed') || 'null');
  const lastViewedEl = document.getElementById('last-viewed');
  if (lastViewed && lastViewedEl) {
    lastViewedEl.textContent = lastViewed.title;
    lastViewedEl.setAttribute('href', `/video/${lastViewed.id}`);
  }

  // Set build time
  const buildTime = document.getElementById('build-time');
  if (buildTime) {
    const now = new Date();
    const options: Intl.DateTimeFormatOptions = {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    buildTime.textContent = now.toLocaleDateString('en-US', options);
  }
</script>
